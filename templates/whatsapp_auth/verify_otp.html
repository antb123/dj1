{% extends "base.html" %}

{% block title %}Verify OTP - MicroLend{% endblock %}
{% block title_text %}Verify Your OTP{% endblock %}

{% block content %}
<div class="bg-white mt-20">
    {% if error %}
        <div class="alert alert-error">{{ error }}</div>
    {% endif %}

    <p class="text-center mb-20">
        Enter the 6-digit code sent to <strong>{{ phone_number }}</strong>
    </p>

    <form method="post" id="verifyForm">
        {% csrf_token %}

        <div class="form-group">
            <label for="otp_code">OTP Code</label>
            <input type="text" id="otp_code" name="otp_code" placeholder="000000" maxlength="6" pattern="[0-9]{6}" required autofocus>
        </div>

        <button type="submit" class="btn">Verify & Login</button>
    </form>

    <p class="text-center text-muted mt-20">
        <a href="{% url 'whatsapp_auth:request_otp' %}">Use different phone number?</a>
    </p>
</div>

<script>
    document.getElementById('verifyForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const button = this.querySelector('button');
        const originalText = button.textContent;
        button.disabled = true;
        button.innerHTML = '<span class="spinner"></span> Verifying...';

        try {
            const response = await fetch('{% url "whatsapp_auth:verify_otp" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: JSON.stringify({
                    otp_code: document.getElementById('otp_code').value
                })
            });

            const data = await response.json();
            if (data.success) {
                window.location.href = data.redirect;
            } else {
                alert('Error: ' + data.error);
                button.disabled = false;
                button.textContent = originalText;
            }
        } catch (error) {
            alert('Error: ' + error.message);
            button.disabled = false;
            button.textContent = originalText;
        }
    });
</script>
{% endblock %}
